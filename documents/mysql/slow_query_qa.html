<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.45">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>慢查询原因 | DongXianZhang</title><meta name="description" content="Welcome to DongXianZhang Site">
    <link rel="modulepreload" href="/assets/app.d2ac80f5.js"><link rel="modulepreload" href="/assets/slow_query_qa.html.c948e987.js"><link rel="modulepreload" href="/assets/slow_query_qa.html.a703c3b1.js"><link rel="prefetch" href="/assets/index.html.09669752.js"><link rel="prefetch" href="/assets/hello.html.947b3903.js"><link rel="prefetch" href="/assets/2022_oppo_qa.html.99adf571.js"><link rel="prefetch" href="/assets/brain_into_submission.html.eff7fd34.js"><link rel="prefetch" href="/assets/index.html.1ab62b18.js"><link rel="prefetch" href="/assets/2022_learn-go-kratos.html.200ec213.js"><link rel="prefetch" href="/assets/index.html.99d6bebd.js"><link rel="prefetch" href="/assets/2022_qa.html.290bb7d8.js"><link rel="prefetch" href="/assets/index.html.4238011f.js"><link rel="prefetch" href="/assets/quick_start_command.html.323dc1b7.js"><link rel="prefetch" href="/assets/2022_learn.html.8b57768e.js"><link rel="prefetch" href="/assets/2022_qa.html.59b09df1.js"><link rel="prefetch" href="/assets/index.html.e6df5284.js"><link rel="prefetch" href="/assets/2022_learn.html.48e63e9b.js"><link rel="prefetch" href="/assets/2022_qa.html.517b47ea.js"><link rel="prefetch" href="/assets/index.html.27f37248.js"><link rel="prefetch" href="/assets/404.html.f166316b.js"><link rel="prefetch" href="/assets/index.html.e8986708.js"><link rel="prefetch" href="/assets/hello.html.716a482e.js"><link rel="prefetch" href="/assets/2022_oppo_qa.html.5d420339.js"><link rel="prefetch" href="/assets/brain_into_submission.html.d7a6b0d5.js"><link rel="prefetch" href="/assets/index.html.e5818b4c.js"><link rel="prefetch" href="/assets/2022_learn-go-kratos.html.6889949c.js"><link rel="prefetch" href="/assets/index.html.ba5118af.js"><link rel="prefetch" href="/assets/2022_qa.html.d66f474a.js"><link rel="prefetch" href="/assets/index.html.aaefbbe7.js"><link rel="prefetch" href="/assets/quick_start_command.html.e9a026f2.js"><link rel="prefetch" href="/assets/2022_learn.html.1ad17158.js"><link rel="prefetch" href="/assets/2022_qa.html.9c3f9366.js"><link rel="prefetch" href="/assets/index.html.dd672c17.js"><link rel="prefetch" href="/assets/2022_learn.html.72f3ccd5.js"><link rel="prefetch" href="/assets/2022_qa.html.fc8309f9.js"><link rel="prefetch" href="/assets/index.html.8213e7dd.js"><link rel="prefetch" href="/assets/404.html.a27babe0.js"><link rel="prefetch" href="/assets/404.011fe4b9.js"><link rel="prefetch" href="/assets/Layout.7802f1c5.js">
    <link rel="stylesheet" href="/assets/style.e04b053e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">DongXianZhang</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Documents"><span class="title">Documents</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Documents"><span class="title">Documents</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/documents/article/index.md" class="" aria-label="Article"><!--[--><!--]--> Article <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/documents/go/index.md" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/documents/php/index.md" class="" aria-label="PHP"><!--[--><!--]--> PHP <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/documents/mysql/index.md" class="router-link-active" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/documents/linux/index.md" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Documents"><span class="title">Documents</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Documents"><span class="title">Documents</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/documents/article/index.md" class="" aria-label="Article"><!--[--><!--]--> Article <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/documents/go/index.md" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/documents/php/index.md" class="" aria-label="PHP"><!--[--><!--]--> PHP <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/documents/mysql/index.md" class="router-link-active" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/documents/linux/index.md" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">Article <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/documents/article/" class="sidebar-item" aria-label="说明"><!--[--><!--]--> 说明 <!--[--><!--]--></a><!----></li><li><a href="/documents/article/brain_into_submission.html" class="sidebar-item" aria-label="让大脑屈服"><!--[--><!--]--> 让大脑屈服 <!--[--><!--]--></a><!----></li><li><a href="/documents/article/2022_oppo_qa.html" class="sidebar-item" aria-label="oppo后端面试题"><!--[--><!--]--> oppo后端面试题 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">Go <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/documents/go/" class="sidebar-item" aria-label="Go简介"><!--[--><!--]--> Go简介 <!--[--><!--]--></a><!----></li><li><a href="/documents/go/2022_learn-go-kratos.html" class="sidebar-item" aria-label="学习go-kratos"><!--[--><!--]--> 学习go-kratos <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">PHP <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/documents/php/" class="sidebar-item" aria-label="PHP简介"><!--[--><!--]--> PHP简介 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active collapsible">MySQL <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/documents/mysql/" class="router-link-active sidebar-item" aria-label="MySQL简介"><!--[--><!--]--> MySQL简介 <!--[--><!--]--></a><!----></li><li><a href="/documents/mysql/2022_qa.html" class="sidebar-item" aria-label="2022 MySQL Q&amp;A"><!--[--><!--]--> 2022 MySQL Q&amp;A <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="慢查询原因"><!--[--><!--]--> 慢查询原因 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#前言" class="router-link-active router-link-exact-active sidebar-item" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#没加索引" class="router-link-active router-link-exact-active sidebar-item" aria-label="没加索引"><!--[--><!--]--> 没加索引 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#索引不生效" class="router-link-active router-link-exact-active sidebar-item" aria-label="索引不生效"><!--[--><!--]--> 索引不生效 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#隐式的类型转换" class="router-link-active router-link-exact-active sidebar-item" aria-label="隐式的类型转换"><!--[--><!--]--> 隐式的类型转换 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#查询条件包含or" class="router-link-active router-link-exact-active sidebar-item" aria-label="查询条件包含or"><!--[--><!--]--> 查询条件包含or <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#like通配符可能导致索引失效" class="router-link-active router-link-exact-active sidebar-item" aria-label="like通配符可能导致索引失效"><!--[--><!--]--> like通配符可能导致索引失效 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#最左前缀匹配原则" class="router-link-active router-link-exact-active sidebar-item" aria-label="最左前缀匹配原则"><!--[--><!--]--> 最左前缀匹配原则 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#使用mysql的内置函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用mysql的内置函数"><!--[--><!--]--> 使用mysql的内置函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#对索引进行列运算" class="router-link-active router-link-exact-active sidebar-item" aria-label="对索引进行列运算"><!--[--><!--]--> 对索引进行列运算 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#索引字段上使用不等判断" class="router-link-active router-link-exact-active sidebar-item" aria-label="索引字段上使用不等判断"><!--[--><!--]--> 索引字段上使用不等判断 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#索引字段上使用is-null-is-not-null" class="router-link-active router-link-exact-active sidebar-item" aria-label="索引字段上使用is null，is not null"><!--[--><!--]--> 索引字段上使用is null，is not null <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#字段编码格式不一样" class="router-link-active router-link-exact-active sidebar-item" aria-label="字段编码格式不一样"><!--[--><!--]--> 字段编码格式不一样 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#优化器选错了索引" class="router-link-active router-link-exact-active sidebar-item" aria-label="优化器选错了索引"><!--[--><!--]--> 优化器选错了索引 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#limit深分页问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="limit深分页问题"><!--[--><!--]--> limit深分页问题 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#limit深分页为什么会变慢" class="router-link-active router-link-exact-active sidebar-item" aria-label="limit深分页为什么会变慢"><!--[--><!--]--> limit深分页为什么会变慢 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#如何优化深分页问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何优化深分页问题"><!--[--><!--]--> 如何优化深分页问题 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#表单数据量太大" class="router-link-active router-link-exact-active sidebar-item" aria-label="表单数据量太大"><!--[--><!--]--> 表单数据量太大 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#为什么会变慢" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么会变慢？"><!--[--><!--]--> 为什么会变慢？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#解决办法" class="router-link-active router-link-exact-active sidebar-item" aria-label="解决办法"><!--[--><!--]--> 解决办法 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#join或者子查询过多" class="router-link-active router-link-exact-active sidebar-item" aria-label="join或者子查询过多"><!--[--><!--]--> join或者子查询过多 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#in元素过多" class="router-link-active router-link-exact-active sidebar-item" aria-label="in元素过多"><!--[--><!--]--> in元素过多 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#数据库在刷脏页" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据库在刷脏页"><!--[--><!--]--> 数据库在刷脏页 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#什么是脏页" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么是脏页？"><!--[--><!--]--> 什么是脏页？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#执行一条更新语句" class="router-link-active router-link-exact-active sidebar-item" aria-label="执行一条更新语句"><!--[--><!--]--> 执行一条更新语句 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#为什么会出现脏页" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么会出现脏页？"><!--[--><!--]--> 为什么会出现脏页？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#什么时候会刷脏页-flush" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么时候会刷脏页（flush）？"><!--[--><!--]--> 什么时候会刷脏页（flush）？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#为什么刷脏页会导致sql变慢呢" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么刷脏页会导致SQL变慢呢？"><!--[--><!--]--> 为什么刷脏页会导致SQL变慢呢？ <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#order-by文件排序" class="router-link-active router-link-exact-active sidebar-item" aria-label="order by文件排序"><!--[--><!--]--> order by文件排序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#拿不到锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="拿不到锁"><!--[--><!--]--> 拿不到锁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#delete-in子查询不走索引" class="router-link-active router-link-exact-active sidebar-item" aria-label="delete + in子查询不走索引"><!--[--><!--]--> delete + in子查询不走索引 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#group-by使用时" class="router-link-active router-link-exact-active sidebar-item" aria-label="group by使用时"><!--[--><!--]--> group by使用时 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/documents/mysql/slow_query_qa.html#系统硬件或网络资源" class="router-link-active router-link-exact-active sidebar-item" aria-label="系统硬件或网络资源"><!--[--><!--]--> 系统硬件或网络资源 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">Linux <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/documents/linux/" class="sidebar-item" aria-label="简介"><!--[--><!--]--> 简介 <!--[--><!--]--></a><!----></li><li><a href="/documents/linux/2022_qa.html" class="sidebar-item" aria-label="测试题"><!--[--><!--]--> 测试题 <!--[--><!--]--></a><!----></li><li><a href="/documents/linux/quick_start_command.html" class="sidebar-item" aria-label="一、快速上手几个命令"><!--[--><!--]--> 一、快速上手几个命令 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="慢查询原因" tabindex="-1"><a class="header-anchor" href="#慢查询原因" aria-hidden="true">#</a> 慢查询原因</h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>日常开发中，我们经常会遇到数据库满查询。<br> 下面是12个常见的原因，以及对应的解决方法。 <img src="/images/mysql/slow_query_qa.png" alt="慢查询问题"></p><h2 id="没加索引" tabindex="-1"><a class="header-anchor" href="#没加索引" aria-hidden="true">#</a> 没加索引</h2><p>如果<strong>没加索引</strong>的话，会导致全表扫描。<br> 因此，应该考虑在where的条件列<strong>建立索引</strong>，尽量避免全表扫描。</p><h2 id="索引不生效" tabindex="-1"><a class="header-anchor" href="#索引不生效" aria-hidden="true">#</a> 索引不生效</h2><p>有时候明明加了索引，但却不生效。<br> 主要有以下经典场景：<br><img src="/images/mysql/index_failure_scanarios.png" alt="索引失效的场景"></p><h3 id="隐式的类型转换" tabindex="-1"><a class="header-anchor" href="#隐式的类型转换" aria-hidden="true">#</a> 隐式的类型转换</h3><p>例如：mobile的字段类型为<strong>字符串</strong>，查询时条件为mobile = 18888888888，传<strong>数字类型</strong>会导致索引失效。</p><h3 id="查询条件包含or" tabindex="-1"><a class="header-anchor" href="#查询条件包含or" aria-hidden="true">#</a> 查询条件包含or</h3><p>例如：查询条件mobile = &#39;18888888888&#39; or age = 18，mobile加了索引，但age没有加索引。假设它走mobile的索引，但是到age查询条件时，它还得全表扫描，也就是需要三步过程：全表扫描➕索引扫描➕合并。<br> 如果一开始就走全表扫描，直接一遍扫描就完事。<br> 优化器出于效率和成本考虑，遇到or条件，让索引失效。<br> 如果or条件的列都加了索引，索引可能会走，也可能不走。建议将查询拆成两句，用union或union all合并查询。</p><h3 id="like通配符可能导致索引失效" tabindex="-1"><a class="header-anchor" href="#like通配符可能导致索引失效" aria-hidden="true">#</a> like通配符可能导致索引失效</h3><p>并不是使用了like通配符，索引一定会失效。而是like查询是以%开头，才会导致索引失效。<br> 需要满足最左匹配原则。</p><h3 id="最左前缀匹配原则" tabindex="-1"><a class="header-anchor" href="#最左前缀匹配原则" aria-hidden="true">#</a> 最左前缀匹配原则</h3><p>建立联合索引时，会遵循最左前缀原则，即最左优先。如果建立一个(a,b,c)的联合索引，相当于建立了(a)、(a,b)、(a,b,c)三个索引。<br> 当查询条件有b时，必须满足有a，才能用到索引。当然，查询条件有c，必须满足得有a和b，才能用索引。 当查询条件有a和c，c就不会用到索引。因为中间缺少b。<br> 联合索引会按照建立时的顺序来匹配列，截止到未匹配上之前。</p><h3 id="使用mysql的内置函数" tabindex="-1"><a class="header-anchor" href="#使用mysql的内置函数" aria-hidden="true">#</a> 使用mysql的内置函数</h3><p>在查询条件的左边使用了内置函数，索引无效。<br> 解决办法：应当把内置函数的逻辑移到右边。</p><h3 id="对索引进行列运算" tabindex="-1"><a class="header-anchor" href="#对索引进行列运算" aria-hidden="true">#</a> 对索引进行列运算</h3><p>当索引列使用运算+、-、*、/，索引不生效。<br> 所以不可以对索引列进行运算，应当在代码处理好，再带入条件查询，或将运算移动到右边。</p><h3 id="索引字段上使用不等判断" tabindex="-1"><a class="header-anchor" href="#索引字段上使用不等判断" aria-hidden="true">#</a> 索引字段上使用不等判断</h3><p>在索引列上使用不等（!=或&lt;&gt;）,索引可能失效。<br> 因为优化器觉得即使走索引，也是需要扫描很多行，</p><h3 id="索引字段上使用is-null-is-not-null" tabindex="-1"><a class="header-anchor" href="#索引字段上使用is-null-is-not-null" aria-hidden="true">#</a> 索引字段上使用is null，is not null</h3><p>例如：有name和card各加索引的字段，当查询name为非空，是会走索引，当然card也是会。但是如果两个条件用or连接起来，索引就会失效。<br> 很多时候，是因为数据量问题，导致优化器放弃走索引。</p><h3 id="字段编码格式不一样" tabindex="-1"><a class="header-anchor" href="#字段编码格式不一样" aria-hidden="true">#</a> 字段编码格式不一样</h3><p>就是前面说的隐式类型转换会导致索引失效。<br> 当连接条件的关联字段编码格式不一样，也会导致索引失效。</p><h3 id="优化器选错了索引" tabindex="-1"><a class="header-anchor" href="#优化器选错了索引" aria-hidden="true">#</a> 优化器选错了索引</h3><p>一张表是可以建立多个索引的。<br> 当执行查询语句的时候，没有指定使用哪个索引的时候，MySQL就会帮你确定用哪个索引。<br> 解决方案：</p><ul><li>使用<code>force index</code>强行选择某个索引</li><li>修改SQL，引导它使用期望的索引</li><li>优化业务逻辑</li><li>优化索引，建立一个更合适的索引，或者删除误用的索引</li></ul><h2 id="limit深分页问题" tabindex="-1"><a class="header-anchor" href="#limit深分页问题" aria-hidden="true">#</a> limit深分页问题</h2><h3 id="limit深分页为什么会变慢" tabindex="-1"><a class="header-anchor" href="#limit深分页为什么会变慢" aria-hidden="true">#</a> limit深分页为什么会变慢</h3><p><code>limit 100000,10;</code>并使用索引查询执行流程：</p><ol><li>通过普通二级索引树，过滤条件，找到满足条件的主键值。</li><li>通过主键值回到聚簇索引，找到满足记录的行，然后取出查询列（回表过程）</li><li>扫描满足条件的100010行，然后人掉前100000行，返回。</li></ol><p>limit深分页，导致查询变慢原因有两个：</p><ul><li>limit语句会先扫描offset + n行，然后再丢弃掉前offset行，返回后n行数据。也就是说<code>limit 100000,10;</code>，就会扫描100010行，而<code>limit 0，10;</code>，只扫描10行。</li><li><code>limit 100000,10</code>扫描更多的行数，也意味着回表更多的次数。</li></ul><h3 id="如何优化深分页问题" tabindex="-1"><a class="header-anchor" href="#如何优化深分页问题" aria-hidden="true">#</a> 如何优化深分页问题</h3><p><strong>通过减少回表次数来优化：</strong><br><strong>标签记录法</strong>：标记上次查询到哪一条记录，下次查找直接从该条记录开始。<br><strong>延迟关联法</strong>：利用覆盖索引，先根据索引查找出主键ID，再根据ID查找数据。</p><h2 id="表单数据量太大" tabindex="-1"><a class="header-anchor" href="#表单数据量太大" aria-hidden="true">#</a> 表单数据量太大</h2><h3 id="为什么会变慢" tabindex="-1"><a class="header-anchor" href="#为什么会变慢" aria-hidden="true">#</a> 为什么会变慢？</h3><p>一个表的数据量达到好几千万或者上亿时，加索引的效果就没那么明显了。性能之所以会变差，是因为维护索引的B+树结构层级变得更高了，查询一条数据时，需要经历的磁盘I/O变多，因此查询性能变慢。</p><h3 id="解决办法" tabindex="-1"><a class="header-anchor" href="#解决办法" aria-hidden="true">#</a> 解决办法</h3><p>千万级别的数据表可以考虑分库分表。 但是分库分表又会导致以下问题：</p><ul><li>事务问题</li><li>跨库问题</li><li>排序问题</li><li>分页问题</li><li>分布式ID</li><li></li></ul><p>评估是否分库前，先考虑下，是否可以把部分历史数据归档。</p><h2 id="join或者子查询过多" tabindex="-1"><a class="header-anchor" href="#join或者子查询过多" aria-hidden="true">#</a> join或者子查询过多</h2><p>一般是不建议使用子查询，可以把子查询改成join来优化。</p><p>而且数据库也有个规范约定：<strong>尽量不要有超过3个以上的表连接</strong>。</p><p>join过多的问题：</p><ul><li>增加SQL复杂度</li><li>数据量过大，会导致join_buffer内存不够，MySQL会在硬盘上创建临时表的方式进行多张表的关联匹配，产生磁盘I/O。</li></ul><p>一般情况，关联2～3个表是可以接受，但是关联的字段需要加索引。<br> 如果需要关联更多的表，建议从代码层面进行拆分，在业务层先查询一张表的数据，然后以关联字段作为条件查询关联表形成map，然后在业务层进行数据的拼装。</p><h2 id="in元素过多" tabindex="-1"><a class="header-anchor" href="#in元素过多" aria-hidden="true">#</a> in元素过多</h2><p>如果使用来in，即使后面的条件加来索引，还是要注意in后面的元素不要过多。<br> in元素一般建议不要超过500个，如果超过来，建议分组，每次500一组进行查询。</p><h2 id="数据库在刷脏页" tabindex="-1"><a class="header-anchor" href="#数据库在刷脏页" aria-hidden="true">#</a> 数据库在刷脏页</h2><h3 id="什么是脏页" tabindex="-1"><a class="header-anchor" href="#什么是脏页" aria-hidden="true">#</a> 什么是脏页？</h3><p>当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为&quot;脏页&quot;。内存数据写入到磁盘后，内存和磁盘上的数据页的内容就一致了，称为&quot;干净页&quot;。一般有更新SQL才可能会导致脏页。</p><h3 id="执行一条更新语句" tabindex="-1"><a class="header-anchor" href="#执行一条更新语句" aria-hidden="true">#</a> 执行一条更新语句</h3><ol><li>执行器会先找引擎取满足条件的行数据。（如果这行所以的数据页本来就在内存中，就直接返回执行器，如果不在就去磁盘读入内存，再返回）</li><li>执行器拿到引擎给的行数据后，修改这一行的指定数据，得到新的一行数据，再调用引擎接口写入这行新数据。</li><li>引擎将这行新数据更新到内存中，同时将这个更新操作记录到redo log里面，但是此时redo log是处于prepare状态。（第一阶段提交）</li><li>执行器生成这个操作的binlog，并把binlog写入磁盘。</li><li>执行器调用引擎的提交事务接口，引擎把刚刚写入的redo log改成提交（commit）状态，更新完成。（第二阶段提交，两阶段提交）</li></ol><p><img src="/images/mysql/update_sql_process.png" alt="更新SQL执行流程"></p><p>InnoDB在处理更新语句的时候，只做来写日志这一个磁盘操作。这个日志叫做redo log（重做日志）。<br> 平时更新SQL执行得很快，其实是因为它只在写内存和redo log，等到空闲得时候，才把redo log里的数据同步到磁盘中。</p><blockquote><p>redo log也在磁盘，为什么不慢？<br> 因为写redo log的过程是顺序写磁盘。磁盘顺序写会减少寻道等待时间，速度比随机写要快得很多。</p></blockquote><h3 id="为什么会出现脏页" tabindex="-1"><a class="header-anchor" href="#为什么会出现脏页" aria-hidden="true">#</a> 为什么会出现脏页？</h3><p>更新SQL只是在写入内存和redo log，等到空闲的时候，才把redo log里的数据同步到磁盘中。这时内存数据页跟磁盘数据页内容不一致，就出现脏页。</p><h3 id="什么时候会刷脏页-flush" tabindex="-1"><a class="header-anchor" href="#什么时候会刷脏页-flush" aria-hidden="true">#</a> 什么时候会刷脏页（flush）？</h3><p>InnoDB存储引擎的redo log大小是固定，且是环形写入的，如下图（图片来源于MySQL实战45讲）： <img src="/images/mysql/redo_log.jpg" alt="redo log"> 刷脏页有以下场景：</p><ul><li>redo log写满来，要刷脏页。这种情况要尽量避免。因为出现这种情况时，整个系统就不能再接受更新了，即所有的更新都必须阻塞。</li><li>内存不够了，需要新的内存页，就要淘汰一些数据页，这时候会刷脏页。</li><li>系统空闲的时候，会刷一些脏页。</li><li>MySQL正常关闭时，会把内存的脏页都flush到磁盘上。</li></ul><h3 id="为什么刷脏页会导致sql变慢呢" tabindex="-1"><a class="header-anchor" href="#为什么刷脏页会导致sql变慢呢" aria-hidden="true">#</a> 为什么刷脏页会导致SQL变慢呢？</h3><ul><li>redo log写满了，要刷脏页，这时候会导致系统所有的更新堵住，写性能都跌为0就慢了。要杜绝出现这个情况。</li><li>一个查询要淘汰的脏页个数太多，会导致查询的响应时间明显变长。</li></ul><h2 id="order-by文件排序" tabindex="-1"><a class="header-anchor" href="#order-by文件排序" aria-hidden="true">#</a> order by文件排序</h2><p>当order by走文件排序时，会变慢。因为将数据放入磁盘临时空间。<br> 一般是当数据需要从新排序，并且sort buff空间不足时，会将数据放入磁盘的临时空间中。 优化：</p><ul><li>因为数据是无序的，所以需要要排序。如果数据本身是有序的，那就不会再用到文件排序。索引数据本身是有序的，我们通过建立索引来优化order by语句。</li><li>我们还可以通过调整max_length_for_sort_data、sort_buffer_size等参数优化。</li></ul><h2 id="拿不到锁" tabindex="-1"><a class="header-anchor" href="#拿不到锁" aria-hidden="true">#</a> 拿不到锁</h2><p>有时候，我们查询一条很简单的SQL，但是却等待很长时间，不见结果返回。一般这种时候就是表被锁住来，或者要查询的某一行或者几行被锁住了。我们只能等待锁被释放。</p><h2 id="delete-in子查询不走索引" tabindex="-1"><a class="header-anchor" href="#delete-in子查询不走索引" aria-hidden="true">#</a> delete + in子查询不走索引</h2><p>select + in子查询会走索引，因为优化器对此做了优化，把子查询改成join的方式，所以可以走索引。<br> delete + in子查询，优化器却没有对它做这个优化。<br> 可以使用explain查看执行计划。</p><h2 id="group-by使用时" tabindex="-1"><a class="header-anchor" href="#group-by使用时" aria-hidden="true">#</a> group by使用时</h2><p>因为group by会用到临时表，有默认用到排序，有时候还可能用到磁盘临时表。 优化方案：</p><ul><li>group by后面的字段加索引</li><li>order by null不用排序</li><li>尽量使用内存临时表</li><li>使用SQL_BIG_RESULT</li></ul><h2 id="系统硬件或网络资源" tabindex="-1"><a class="header-anchor" href="#系统硬件或网络资源" aria-hidden="true">#</a> 系统硬件或网络资源</h2><ul><li>如果数据库服务器内存、硬件资源，或者网络资源配置不是很好，就会慢一些。这时候可以升级配置。</li><li>如果数据库压力本身很大，比如高并发场景下，大量请求到数据库来，数据服务器CPU占用很高或者I/O利用率很高，这种情况下所有语句的执行都有可能变慢。</li></ul><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: dxzhangg@foxmail.com">dxzhangg</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/documents/mysql/2022_qa.html" class="" aria-label="2022 MySQL Q&amp;A"><!--[--><!--]--> 2022 MySQL Q&amp;A <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.d2ac80f5.js" defer></script>
  </body>
</html>
